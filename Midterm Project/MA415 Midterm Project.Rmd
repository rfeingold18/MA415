---
title: "MA415 Midterm Project"
author: "Rachel Feingold"
date: "3/7/2017"
output: pdf_document
---
##Instructions:
Prepare the OSHA data and create a dataset for analysis.
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
##Reading Data:

## Libraries Needed:
```{r}
require(foreign) # the require functions loads and attached the add on packages needed for the rest of the program, better than library
require(dplyr)
require(tidyr)
require(ggplot2)
require(lubridate)
require(stringr)
require(magrittr)
require(data.table)
```

I only read the data that was neccessary to the analysis of the most dangerous places to work in Massachusetts.
The data tables I choose to include in the final dataset were:

  Osha.dbf- I chose this data table because it was the main table with the companys names, addresses, inspection dates and other descriptions information about the comapnies. 
  Accid.dbf- I chose this data table because it had details about the accidents, which is clearly related to the dangerous levels of workplaces in Massachusetts. I extracted the variables: ACTIVITYNO DEGREE, NATURE, SOURCE, EVENT, ENVIRON, HUMAN, and HAZSUB. 
  Viol.dbf- I chose this data table because it had details on the violations of each inspection. If a company has more violations during an OSHA inspection, then a workplace may be more dangerous to work at. I extracted the variables: ACTIVITYNO, EMPHASIS, PENCURRENT, VIOLTYPE, INSTANCES, and NUMEXPOSED. 
  History.dbf- I chose this data table because it had details on the history of the penalties imposed on the company and other violations. If a company has many penalties, this may be related to how it complies to safety and health regualtions. I extracted the variables: ACTIVITYNO, HISTTYPE, HISTEVENT, HISTVTYPE, and FTAEVENT. 
  Relact.dbf- I chose this data table because it had details on whether the inspection was related to another inspection or other action. This can give more information on whether a company is compliant with OSHA guidelines. I extracted the variables: ACTIVITYNO, RELTYPE, SAFETY, and HEALTH.

```{r}
osha <- read.dbf("osha.dbf")
accidents <- read.dbf("accid.dbf")
violations <- read.dbf("viol.dbf")
history <- read.dbf("history.dbf")
relact <- read.dbf("relact.dbf")
```
I also needed to read in the data from lookups, in order to retrieve informations on the coding and different character levels of the various variables.
```{r}
acc <- read.dbf("lookups/acc.dbf")
hzs <- read.dbf("lookups/hzs.dbf")
sic <- read.dbf("lookups/sic.dbf") 
scc <- read.dbf("lookups/scc.dbf")
```

##Cleaning Data

First, I cleaned the OSHA table. I selected the variables (columns) I deemed most important to the analysis and I discarded the rest. Kept variables included:
PREVCTTYP- type of most recent OSHA activity (accident, none, complaint, inspection, referral)
ACTIVITYNO- unique identifier for each inspection record
REPORTID- unique identification code, one for each federal and state office submitting compliance data
ESTABNAME- name of company/establishment
SITECITY- Depertment of Commerce city code establishment is in
SITECNTY- Department of Commerce county code establishment is in
SITEZIP- zipcode of the establishment
OWNERTYPE- type of owner of company (private, local government, state government, federal government)
ADVNOTICE- whether an advanced notice of the inspection of given 
CAT_SH- safety or health codes
INSPTYPE- type of inspection (unprogrammed: fatality/ catashrophe, complaint, referral, monitoring, follow-up, etc; Programmed: planned, related, etc)
INSPSCOPE- how indepth the inspection was (comprehensive, partial, records only, none)
WHYNOINSPC- if there was no inspection, reason for such (estb. not found, denied entry, employer out of business, etc.) 
PASUMHOURS- sum of all inspection activity hours reported 
TOTPENLTY- total current penalities issued
TOTALFTA- total failure to abate (FTA) penalties issued
TOTALVIOLS- total number of violations issued
TOTSERIOUS- total number of serious, willful, and repeat violations issued for inspection


I also turned the character variables that had coding levels, and assigned names to these levels based on the layout text files. In other instances I used the the layout file with descriptions of the variables usually references the lookups dbf's. I would then use the .dbf to help name the levels, and eventually delete the redundant columns. 
```{r} 
tidyosha <- osha[-c(1:4, 6, 9:11, 14:15, 17, 19:20, 22:24, 27:33, 35:59, 61:63, 68:76, 80:92) ]
rm(osha)

levels(tidyosha$PREVCTTYP) <- c("Accident", "Complaint", "Inspection", "Referral")
levels(tidyosha$OWNERTYPE) <- c("Private", "Local Govt.", "State Govt.", "Federal Govt.")
levels(tidyosha$ADVNOTICE) <- c("No", "Yes")
levels(tidyosha$CAT_SH) <- c("Health", "Safety")
levels(tidyosha$INSPTYPE) <- c("Fatality/Catastrophe","Complaint", "Referral", "Monitoring","Variance", "Follow-Up", "Related", "Other", "Programmed-Planned","Programmed-Related", "Programmed-Other", "Non-Inspection")
levels(tidyosha$INSPSCOPE) <- c("Comprehensive", "Partial", "Records Only", "No Inspection")

tidyosha <- left_join(tidyosha, sic, by = "SIC")
tidyosha <- select(tidyosha, -SIC)
rm(sic)
```
3. Next, I cleaned the data from the accidents table. 
I kept the variables: 
ACTIVITYNO- unique identifier for each inspection record
DEGREE- extent of injury (fatal, hospoitalized, nonhispitalized)
NATURE- nature of the injury (physical characteristics of the injury)
SOURCE- cause/source of injury
EVENT- event/action that caused the injury
ENVIRON- contributing factor of the injury 
HUMAN- any human factory involved in the injury
HAZSUB- any hazardous substances contributing to the incident
```{r}
tidyaccid <- accidents[-c(2:5,8,13,15:16)]
rm(accidents)
```
4. Then, I recoded and renamed the character variables.
```{r}
levels(tidyaccid$DEGREE) <- c("no injury", "fatality", "hospitalized", "nonhospitalized")

natureinj <- acc[(acc$CATEGORY=="NATUR-INJ"),]
natureinj <- select(natureinj, CODE, VALUE)
colnames(natureinj) <- c("NATURE", "VALUE")
tidyaccid <- left_join(tidyaccid, natureinj, by = "NATURE")
tidyaccid <- select(tidyaccid, -NATURE)
names(tidyaccid)[8] <- "NATURE-INJ"
rm(natureinj)

injsource <- acc[(acc$CATEGORY=="SOURC-INJ"),]
injsource <- select(injsource, CODE, VALUE)
colnames(injsource) <- c("SOURCE", "VALUE")
tidyaccid <- left_join(tidyaccid, injsource, by = "SOURCE")
tidyaccid <- select(tidyaccid, -SOURCE)
names(tidyaccid)[8] <- "INJ-SOURCE"
rm(injsource)

etype <- acc[(acc$CATEGORY=="EVENT-TYPE"),]
etype <- select(etype, CODE, VALUE)
colnames(etype) <- c("EVENT", "VALUE")
tidyaccid <- left_join(tidyaccid, etype, by = "EVENT")
tidyaccid <- select(tidyaccid, -EVENT)
names(tidyaccid)[8] <- "TYPE-EVENT"
rm(etype)

envfac <- acc[(acc$CATEGORY=="ENVIR-FAC"),]
envfac <- select(envfac, CODE, VALUE)
colnames(envfac) <- c("ENVIRON", "VALUE")
tidyaccid <- left_join(tidyaccid, envfac, by = "ENVIRON")
tidyaccid <- select(tidyaccid, -ENVIRON)
names(tidyaccid)[8] <- "ENVIR-FAC"
rm(envfac)

humfac <- acc[(acc$CATEGORY=="HUMAN-FAC"),]
humfac <- select(humfac, CODE, VALUE)
colnames(humfac) <- c("HUMAN", "VALUE")
tidyaccid <- left_join(tidyaccid, humfac, by = "HUMAN")
tidyaccid <- select(tidyaccid, -HUMAN)
names(tidyaccid)[8] <- "HUMAN-FAC"
rm(humfac)

names(tidyaccid)[3] <- "CODE"       # Needed to rename the column to do a join with the lookups code dbf
tidyaccid <- left_join(tidyaccid, hzs, by = "CODE") 
tidyaccid <- select(tidyaccid, -CODE)
names(tidyaccid)[8] <- "HAZ-SUB"

```


5. Next, I cleaned the violations table. I kept the variables:
ACTIVITYNO- unique identifier for each inspetion record
EMPHASIS- whether violation was egregious (outstandingly bad)
GRAVITY- level of potential arm to worker (scale of 1-10)
PENCURRENT- total amount OSHA collected or expects to collect from violations
VIOLTYPE- type of violation (repeat, serious, unclassified, willful, other)
INSTANCES- number of unstances of violation of standard related event
NUMEXPOSED- humber of employees exposed to hazard violate

I also changed the character variables that were encoded with codes instead of their actual names. 
```{r}
tidyviol <- violations[-c(2:7, 11, 13:15, 17, 19:48)]
rm(violations)

levels(tidyviol$EMPHASIS) <- c("Egregious")
levels(tidyviol$VIOLTYPE) <- c("Other", "Repeat", "Serious", "Unclassified", "Willful")

```
6. Next, I cleaned the history table. I also changed the character variables that were encoded with codes instead of their actual names. 
```{r}
tidyhist <- history[-c(2:4, 6:7, 9:10, 12:15, 17:19)]
rm(history)

levels(tidyhist$HISTTYPE) <- c("Failure-To-Abate", "Penalty")
levels(tidyhist$HISTEVENT) <- c("Appeals Court", "Supreme Court", "Amendment", "Govt Dismissed", "Formal Settlement", "Informal Settlement", "ALJ Decision", "Unknown", "Petition to Modify" , "Review Commission", "Employer Withdrew", "Issued")
levels(tidyhist$HISTVTYPE) <- c("Other", "Repeat", "Serious", "Unclassfied", "Willful")
levels(tidyhist$FTAEVENT)  <- c("Appeals Court", "Govt Dismissed", "Formal Settlement", "Informal Settlement", "ALJ Decision", "Unknown", "Issued")
```
7. Next, I cleaned the relact table and changes any character variables that were unclearing with the coding given to us. 
```{r}
tidyrelact <- relact[-c(2:3, 5)]
rm(relact)

levels(tidyrelact$RELTYPE) <- c("Accident", "Complaint", "Inspection", "Referral")
levels(tidyrelact$SAFETY) <- c("Satisfied")
levels(tidyrelact$HEALTH) <- c("Satisfied")
```
##Organizing Data 
1. After cleaning the most useful databases, I need to join the tables together, using OSHA as the base. The common variable throughout all the tables is AVTIVITYNO, which I used to join the columns. Some numbers in the ACTIVITYNO field appear more than once because an inspection may have more violations than one record can contain. This is more evident of a dangerous place to work because it means a lot of violated activity happened at this company. 
```{r}
master <- full_join(tidyosha, tidyaccid, by ="ACTIVITYNO")
master <- full_join(master, tidyviol, by = "ACTIVITYNO")
master <- full_join(master, tidyhist, by = "ACTIVITYNO")
master <- full_join(master, tidyrelact, by = "ACTIVITYNO")

master <- master[c(4,5,6,17,18,19,6,2,3,1,9,10,8,7,11,12,20,21,22,23,24,25,26,15,16,28,27,30,31,32,29,33,13,34,35,14,36,37,38,39)]
unimaster <- unique(master) # this eliminates duplicate rows
distinct <- distinct(master) # this does same thing unique() just wanted to see the difference, unique returns original row numbers tho 
rm(master)
```
2. Next, I removed the cleaned data tables, just to clean up the environment.
```{r}
rm(acc,hzs,scc,tidyaccid,tidyhist,tidyosha,tidyrelact,tidyviol)
```
3. Next, I wanted to check that the NA data was coded correctly. For this I looked at the quantitative variables and their distributions on graphs with ggplot.

```{r}
sum(unimaster$PASUMHOURS.has.na)
sum(unimaster$TOTALVIOLS.has.na)
sum(unimaster$TOTSERIOUS.has.na)
sum(unimaster$GRAVITY.has.na)
sum(unimaster$PENCURRENT.has.na)
sum(unimaster$TOTALFTA.has.na) 
sum(unimaster$TOTPENLTY.has.na)
# None of the quantitative variables are coded with NA's which makes statistical analysis easier
quant <- select(unimaster)
# Group all the Quantitative data in a subset dataset


# summarise(unimaster, funs(mean()))
# 
# quant <- subset(
set = subset(unimaster, subset = INSPTYPE=="Complaint")
# table(set$PASUMHOURS)
# set$PASUMHOURS <- set$PASUMHOURS==0
is.na(o$PASUMHours) <- !o$pasumhours

ggplot(data=unimaster, aes(x = PASUMHOURS)) + geom_histogram() + xlim(c(1,100))
# The majority of the values are 0's which is okay. This does not mean that the total sum of inspection activity for these records was 0, it just means that the data was not recorded. 

```
