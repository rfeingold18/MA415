---
title: "MA415 Midterm Project"
author: "Rachel Feingold"
date: "3/7/2017"
output: pdf_document
---
Instructions:

Prepare the OSHA data and create a dataset for analysis.
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Libraries Needed:
```{r}
require(foreign)
require(dplyr)
require(tidyr)
require(ggplot2)
require(lubridate)
require(stringr)
require(magrittr)
require(data.table)
```
Reading Data:

I only read the data that was neccessary to the analysis of the most dangerous places to work in Massachusetts.
```{r}
osha <- read.dbf("osha.dbf")
accidents <- read.dbf("accid.dbf")
violations <- read.dbf("viol.dbf")
 hazsub <- read.dbf("hazsub.dbf")
# history <- read.dbf("history.dbf")
# admpay <- read.dbf("admpay.dbf")

```
I also needed to read in the data from lookups, in order to retrieve informations on the coding and different character levels of the various variables.
```{r}
acc <- read.dbf("lookups/acc.dbf")
hzs <- read.dbf("lookups/hzs.dbf")
```

Cleaning Data

1. First, I cleaned the OSHA table. I am starting with this one because it is the main table and it has the company names, address, date of inspection, and other descriptive information about the companies.

2. Then, I selected the variables (columns) I deemed most important to the analysis and I discarded the rest. 
```{r} 
tidyosha <- osha[-c(1:4, 9:11, 14:15, 17, 19:20, 22:24, 27:33, 35:59, 61:63, 68:77, 80:92) ]
rm(osha)
```
3. Next, I cleaned the data from the accidents table. 
```{r}
tidyaccid <- accidents[-c(2:5,8,13,15:16)]
rm(accidents)
```
4. Then, I turned the character variables that had many levels, assigned names to the levels, if there weren't many. If there were many levels, the layout file with descriptions of the variables usually references the lookups dbf's. I would then use the .dbf to help name the levels, and eventually delete the redundant columns. 
```{r}
levels(tidyaccid$DEGREE) <- c("no injury", "fatality", "hospitalized", "nonhospitalized")

natureinj <- acc[(acc$CATEGORY=="NATUR-INJ"),]
natureinj <- select(natureinj, CODE, VALUE)
colnames(natureinj) <- c("NATURE", "VALUE")
tidyaccid <- left_join(tidyaccid, natureinj, by = "NATURE")
tidyaccid <- select(tidyaccid, -NATURE)
names(tidyaccid)[8] <- "NATURE-INJ"

injsource <- acc[(acc$CATEGORY=="SOURC-INJ"),]
injsource <- select(injsource, CODE, VALUE)
colnames(injsource) <- c("SOURCE", "VALUE")
tidyaccid <- left_join(tidyaccid, injsource, by = "SOURCE")
tidyaccid <- select(tidyaccid, -SOURCE)
names(tidyaccid)[8] <- "INJ-SOURCE"

etype <- acc[(acc$CATEGORY=="EVENT-TYPE"),]
etype <- select(etype, CODE, VALUE)
colnames(etype) <- c("EVENT", "VALUE")
tidyaccid <- left_join(tidyaccid, etype, by = "EVENT")
tidyaccid <- select(tidyaccid, -EVENT)
names(tidyaccid)[8] <- "TYPE-EVENT"

envfac <- acc[(acc$CATEGORY=="ENVIR-FAC"),]
envfac <- select(envfac, CODE, VALUE)
colnames(envfac) <- c("ENVIRON", "VALUE")
tidyaccid <- left_join(tidyaccid, envfac, by = "ENVIRON")
tidyaccid <- select(tidyaccid, -ENVIRON)
names(tidyaccid)[8] <- "ENVIR-FAC"

humfac <- acc[(acc$CATEGORY=="HUMAN-FAC"),]
humfac <- select(humfac, CODE, VALUE)
colnames(humfac) <- c("HUMAN", "VALUE")
tidyaccid <- left_join(tidyaccid, humfac, by = "HUMAN")
tidyaccid <- select(tidyaccid, -HUMAN)
names(tidyaccid)[8] <- "HUMAN-FAC"

names(tidyaccid)[3] <- "CODE"       # Needed to rename the column to do a join with the lookups code dbf
tidyaccid <- left_join(tidyaccid, hzs, by = "CODE") 
tidyaccid <- select(tidyaccid, -CODE)
names(tidyaccid)[8] <- "HAZ-SUB"

```


7. Next, I cleaned the violations table. 
```{r}
tidyviol <- violations[-c(2:7, 11, 13:15, 17, 19:48)]
rm(violations)
```


Organizing Data 
